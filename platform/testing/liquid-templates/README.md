# Liquid Template Unit Testing Framework

The Liquid Template Unit Testing Framework was created to replace Cypress for unit testing the logic in `liquid` templates because Cypress is slow, heavy, and is overkill for this purpose. More importantly, this framework provides us with total control over the test data which is critical for testing `liquid` templates, something that Cypress does not provide. For example, a you can test a given `liquid` template against any number of fixtures that represent different entries into the Drupal CMS, so bugs in `liquid` templates can be discovered more quickly.

**Please note**: End-to-end (e2e) tests on VA.gov use Cypress; Cypress has NOT been replaced by this tool.

## How to Use the Framework
To test a `liquid` template, use the `parseFixture()` and `renderHTML()` functions in [`src/site/tests/support/index.js`](https://github.com/department-of-veterans-affairs/vets-website/blob/master/src/site/tests/support/index.js) to create an `HTML` document. Run accessibility checks using the `axeCheck()` function in [`src/site/tests/support/axe.js`](https://github.com/department-of-veterans-affairs/vets-website/blob/master/src/site/tests/support/axe.js).

### `parseFixture()`
`parseFixture()` takes a `JSON` fixtures path starting from `src/` and returns a `JavaScript` object.

### `renderHTML()`
`renderHTML()` takes a `liquid` template path starting from `src/` and the `JavaScript` object returned by `parseFixture()` and renders an `HTML` document. We can then run the usual Mocha assertions on the result. This function uses the same code as our build process, so all of our custom `liquid` filters can be used.

This technique can be used to generate tests of varying complexity, ranging from simple rendering sanity checks to complex logic. Since we control the `JSON` test data, we can easily test different scenarios.

### `axeCheck()`
`axeCheck()` takes the `HTML` document returned by `renderHTML()` and an optional `axe-core` [options parameter](https://www.deque.com/axe/core-documentation/api-documentation/#options-parameter) and returns an array of accessibility violations.

The `CSS` file for the static pages found on VA.gov is generated during the build process, and therefore, cannot be referenced by the `HTML` files generated by this tool. Because of this, accessibility checks for things that require the `CSS` file, such as color-contrast and visability checks, cannot be performed. We have configured `axeCheck()` to only check for accessibility violations that can be detected on the `HTML` documents generated by this tool (i.e. checks that don't require `CSS`).

Run an accessibility check like this:

```js
it('reports no axe violations', async () => {
  const violations = await axeCheck(container);
  expect(violations.length).to.equal(0);
});
```

Accessibility violations are logged to the console and look like this:

```javascript
1 Accessibility Violation Was Detected

Axe Violation 1:
 {
  id: 'document-title',
  impact: 'serious',
  tags: [ 'cat.text-alternatives', 'wcag2a', 'wcag242', 'ACT' ],
  description: 'Ensures each HTML document contains a non-empty <title> element',
  help: 'Documents must have <title> element to aid in navigation',
  helpUrl: 'https://dequeuniversity.com/rules/axe/4.1/document-title?application=axeAPI',
  nodes: [
    {
      any: [Array],
      all: [],
      none: [],
      impact: 'serious',
      html: '<html lang="en">',
      target: [Array],
      failureSummary: 'Fix any of the following:\n' +
        '  Document does not have a non-empty <title> element'
    }
  ]
}

Node 1:
 {
  any: [
    CheckResult {
      id: 'doc-has-title',
      data: null,
      relatedNodes: [],
      impact: 'serious',
      message: 'Document does not have a non-empty <title> element'
    }
  ],
  all: [],
  none: [],
  impact: 'serious',
  html: '<html lang="en">',
  target: [ 'html' ],
  failureSummary: 'Fix any of the following:\n' +
    '  Document does not have a non-empty <title> element'
}
```

## Rendered `html` Is Saved to Disk
For convenience, the `HTML` that's generated from each `liquid` template is automatically saved to `src/site/tests/html` when tests are executed so the `HTML` can be inspected when writing tests. These files are gitignored.

## Sample Test
Here is a sample test:

```js
const layoutPath = 'src/site/layouts/landing_page.drupal.liquid';

describe('intro', () => {
  describe('no fieldTitleIcon', () => {
    const data = parseFixture(
      'src/site/layouts/tests/landing_page/fixtures/landing_page.json',
    );

    it('renders elements with expected values', async () => {
      const container = await renderHTML(layoutPath, data);
      expect(container.querySelector('h1').innerHTML).to.equal(data.title);
      expect(container.querySelector('.va-introtext p').innerHTML).to.equal(
        data.fieldIntroText,
      );
      expect(
        container.querySelector('i.icon-large.white.hub-icon-foo'),
      ).to.equal(null);
    });
  });
});
```

## Sample Spec Files
Here are several example spec files:
- [src/site/layouts/tests/landing_page/landing_page.unit.spec.js](https://github.com/department-of-veterans-affairs/vets-website/blob/master/src/site/layouts/tests/landing_page/landing_page.unit.spec.js)
- [src/site/layouts/tests/vamc/health_care_region_page.unit.spec.js](https://github.com/department-of-veterans-affairs/vets-website/blob/master/src/site/layouts/tests/vamc/health_care_region_page.unit.spec.js)
