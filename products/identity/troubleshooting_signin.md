# Troubleshooting Authentication Errors

Authentication error codes are generated by the API when an error is detected. A user is then redirected back to VA.gov with that error code in the browser address bar (example `https://va.gov/auth/login/callback/?auth=fail&code=001`).  Error codes can be found in two places, either on the page at bottom or in the URL bar. Below is a collection of those error codes along with possible troubleshooting steps.

## Version History

| Version Number | Author | Revision Date | Description of Change |
| --- | --- | --- | --- |
| 0.1 | Alex Garcia | 7/11/2022 | Initial creation |

## Table of Contents
- [Error Codes](#directory-of-error-codes)
- [Troubleshooting](#troubleshooting)
- [Occurrence](#error-codes-by-occurrence)

## Directory of Error Codes
| Error Code | Title | How to fix |
| ---: | :--- | --- |
| `001` | Authorization Denied by User | [Troubleshooting steps](#user-denied) |
| `002` | User system time is incorrect | [Troubleshooting steps](#user-time-bad) |
| `003` | API Server time is incorrect | [Troubleshooting steps](#server-time-bad) |
| `004` | MPI Mismatch | [Troubleshooting steps](#mpi-mismatch) |
| `005` | Session Expired | [Troubleshooting steps](#session-expired) |
| `007` | Default/Unknown Error | [Troubleshooting steps](#default-unknown) |
| `009` | Failure to Proof (Login.gov) | [Troubleshooting steps](#failure-to-proof) |
||||
| `101` | Multiple MHV IDs (MHV IENs) | [Troubleshooting steps](#multiple-mhv-ids) |
| `102` | Multiple EDIPIs | [Troubleshooting steps](#multiple-edipis) |
| `103` | ICN Mismatch | [Troubleshooting steps](#icn-mismatch) |
| `104` | UUID Missing | [Troubleshooting steps](#uuid-missing) |
| `106` | Multiple Corp IDs | [Troubleshooting steps](#multiple-corp-ids) |
||||
| `201` | Default/Unknown OAuth Error | [Troubleshooting steps](#default-unknown-oauth) |
| `202` | State Mismatch (OAuth) | [Troubleshooting steps](#state-mismatch-oauth) |
| `203` | Invalid Request (OAuth) | [Troubleshooting steps](#invalid-request-oauth) |


## Troubleshooting
<details>
  <summary>
    <h3 id="user-denied">001 - Authorization Denied by User</h3>
  </summary>

#### Why does it happen?
The Authorization Denied by User error usually occurs when a user who signs in with ID.me and clicks the **"Deny"** button on the final page of the identity verification process when authorizing sharing information with VA.gov and ID.me.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. When prompted on ID.me to share information your information with VA.gov, click the **"Accept"** on the final page of the identity verification process
4. User continues to sign in as normal
</details>


<details>
  <summary>
    <h3 id="user-time-bad">002 - User system time is incorrect</h3>
  </summary>

#### Why does it happen?
This can happen when a user's computer date and time is set manually rather than automatically causing a user to be signed out or enter into a authentication loop.

#### How to troubleshoot: 
1. On a User's computer, ask them to locate the Date and Time
    1. **Windows**:
        1. Right-click on the time in the bottom-right of the screen and selected **Adjust Date/Time** (opens a new window)
        2. On the left-side of the window select the **Date & time** tab.
        3. Ensure a user has the **Set time automatically** enabled (On)
        4. Ensure a user has the **Set time zone automatically** enabled (On)
    2. **Mac**:
        1. Click the Apple icon (top left)
        2. Select System Prefrences
        3. Click the Date & Time
        4. Ensure a user has the **Set date and time automatically** enabled (checked)
2. Have the User attempt to Sign in again with their credential provider
3. User continues to sign in as normal
</details>

<details>
  <summary>
    <h3 id="server-time-bad">003 - API Server time is incorrect</h3>
  </summary>

#### Why does it happen?
This error occurs when the `tzinfo` (time zone information) on VA.gov's API server is misconfigured or missing.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. _
</details>

<details>
  <summary>
    <h3 id="mpi-mismatch">004 - MPI Mismatch</h3>
  </summary>

#### Why does it happen?


#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. When prompted on ID.me to share information between ID.me & VA.gov, click Approve
4. User continues to sign in as normal
</details>

<details>
  <summary>
    <h3 id="session-expired">005 - Session Expired</h3>
  </summary>

#### Why does it happen?
This usually occurs when a session was invalidated during the Sign in process or the user was inactive for a period of 30 minutes or more during the Sign in process.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
</details>

<details>
  <summary>
    <h3 id="default-unknown">007 - Default/Unknown Error</h3>
  </summary>

#### Why does it happen?
This error can occur for a variety of different reasons. Sometimes we are not sure what the error is and it doesn't match any of our other errors OR we don't want to display the error to the user in certain cases like token theft flag, death flag, etc.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. _
</details>

<details>
  <summary>
    <h3 id="failure-to-proof">009 - Failure to Proof (Login.gov)</h3>
  </summary>

#### Why does it happen?
This error occurs only with the Login.gov service provider and is happens when a user encounters an error when trying to prove their identity through Login.gov's workflow.  This can happen if a user exits out of the workflow voluntarily, provides the wrong phone number, provides an inaccurate/malformed social security number, or etc.

#### How to troubleshoot: 
1. Confirm with the user the Login.gov's workflow that was previously attempted (verifying phone number, SSN, etc.)
2. Create a ticket with _ to update the users MPI record (SSN) or have them update their own phone number
3. _
</details>

<details>
  <summary>
    <h3 id="multiple-mhv-ids">101 - Multiple MHV IDs (multiple IENs)</h3>
  </summary>

#### Why does it happen?
This error occurs when a user signs in with their My HealtheVet credential and there are multiple IDs associated with their account.  This is only an issue on VA.gov and not the My HealtheVet website.  VA.gov's API is unable to compare which MHV ID is the most recent/active ID and is unable to perform lookups against multiple IDs at the same time.

#### How to troubleshoot: 
1. Create a ticket with _
2. Try to Sign in again with their credential provider
3. _
</details>

<details>
  <summary>
    <h3 id="multiple-edipis">102 - Multiple EDIPIs</h3>
  </summary>

#### Why does it happen?


#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. When prompted on ID.me to share information between ID.me & VA.gov, click Approve
4. User continues to sign in as normal
</details>


<details>
  <summary>
    <h3 id="icn-mismatch">103 - ICN Mismatch</h3>
  </summary>

#### Why does it happen?


#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. _
</details>


<details>
  <summary>
    <h3 id="uuid-missing">104 - UUID Missing</h3>
  </summary>

#### Why does it happen?
This error is encountered when a user attempts to sign in with their credentials for either DS Logon or My HealtheVet.  A UUID is required to lookup the user and is only generated via ID.me or Login.gov. Therefore if a user has never signed in with either ID.me or Login.gov, the API cannot cross-reference and lookup their information in MPI.

#### How to troubleshoot: 
1. Ask the user to create a new Login.gov or ID.me account
2. If required, ask the user to upgrade their account by proving their identity through Login.gov or ID.me.
  a. This process should take between 5-10 minutes and the user will need their SSN, smart phone, and a form of identification (eg driver's license, state-issued ID)
3. _
</details>


<details>
  <summary>
    <h3 id="multiple-corp-ids">106 - Multiple Corp IDs</h3>
  </summary>

#### Why does it happen?
This occurs when there is an error in MPI and 2 records of the Corp ID is used

#### How to troubleshoot: 
1. Contact _ to 

</details>

<details>
  <summary>
    <h3 id="default-unknown-oauth">201 - Default Error (OAuth)</h3>
  </summary>

#### Why does it happen?
This error can occur for a variety of different reasons. Sometimes we are not sure what the error is and it doesn't match any of our other errors OR we don't want to display the error to the user in certain cases like token theft flag, death flag, etc.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. _
</details>

<details>
  <summary>
    <h3 id="state-mismatch-oauth">202 - State Mismatch (OAuth)</h3>
  </summary>

#### Why does it happen?
This occurs when the state in the initial OAuth request DOES NOT match the response state.  This helps to prevent the request to being tricked into sending arbitrary authorization codes to unauthorized endpoints.

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. _
</details>

<details>
  <summary>
    <h3 id="invalid-request-oauth">203 - Invalid Request (OAuth)</h3>
  </summary>

#### Why does it happen?
This error is generated when one or more of the query parameters are either missing or not defined on one or more routes (`/callback`, `/token`, or `/refresh`)

#### How to troubleshoot: 
1. Ask the User to clear their cookies & cache
2. Try to Sign in again with their credential provider
3. When prompted on ID.me to share information between ID.me & VA.gov, click Approve
4. User continues to sign in as normal
</details>

## Error Codes by Occurrence
Below is a list of the top 10 error codes that are listed by occurrence (Google Analytics)

| # | Title | Query Parameters |
| ---: | --- | --- | 
| 1 | 104 - UUID Missing | `code=104 + type=custom + auth=force-needed` |
| 2  | 007 - Default/Unknown Error | `code=007 + type=custom + auth=force-needed` |
| 3  | 106 - Multiple Corp IDs | `code=106 + type=idme` |
| 4  | 106 - Multiple Corp IDs | `code=106 + type=dslogon` |
| 5  | 106 - Multiple Corp IDs | `code=106 + type=mhv` |
| 6  | 106 - Multiple Corp IDs | `code=106 + type=custom + force-needed=true` |
| 7  | 106 - Multiple Corp IDs | `code=106 + type=logingov` |
| 8  | 104 - UUID Missing | `code=104 + type=dslogon` |
| 9  | 106 - Multiple Corp IDs | `code=106 + type=idme + next=loginModal` |
| 10 | 103 - ICN Mismatch | `code=103 + type=mhv` |
