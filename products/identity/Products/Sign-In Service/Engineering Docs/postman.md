# VA.gov Identity Collection

The VA.gov Identity team maintains a [Postman Collection](https://github.com/department-of-veterans-affairs/va.gov-team-sensitive/blob/master/teams/vsp/teams/Identity/Product%20Documentation/va_identity_postman.json) that can be used to test all of the different Sign-in Service (SiS) auth flows.

## VA Identity Collection Variables

The variable values needed to connect to a SiS instance are managed within the `Variables` subtab in the `VA Identity` collection management:
![VA Identity Postman Variables view](https://github.com/department-of-veterans-affairs/va.gov-team/assets/20125855/af6bbe34-aba9-448c-bbe1-2f1de549f7ad)

## Localhost authentication

The Identity Postman collection cannot perfectly imitate a web browser - in particular the initial authorization with a CSP must be performed in a web browser due to the necessity of completing various web forms. In order to use the Postman collection begin with the following steps:

1. Make sure that your local instance of `vets-api` (localhost:3000) is running and `vets-website` (localhost:3001) is NOT, as the latter will automatically call the `/token` endpoint at the end of the callback process, consuming the auth_code that is needed for use in Postman.
2. Navigate in your web browser to the `/authorize` endpoint generated by Postman. It is critical that the `code_challenge` is either the same as Postman's saved variable or generated from a `code_verifier` that you have access to in order for the later token request to work. You can also choose your preferred `client_id`, the most common being `vaweb` (default) & `vamobile`. In order to easily copy the generated Postman URL you can use the 'Documentation' view in the right sidebar:
    ![authorize_request](https://github.com/department-of-veterans-affairs/va.gov-team/assets/20125855/3c691624-8674-4a3b-934a-7a75b2141f95)

    `http://localhost:3000/v0/sign_in/authorize?type=logingov&acr=ial2&client_id=vaweb&code_challenge=JNkFflCkxk1K6gQUf23P_5Ctl_T65_xkkOU_y-Cc2XI=&code_challenge_method=S256&state=c4addf6001661631d2524043ca31107e`
3. Complete the CSP authentication and find the `callback` call that `vets-api` makes to `vets-website` at the end of the authentication process. This can either be done in your web browser or in Postman via the [Postman Interceptor](https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?hl=en) plugin:
    ![SiS vets-website callback](https://github.com/department-of-veterans-affairs/va.gov-team/assets/20125855/efc20692-5814-4291-8c1e-4dd7dbda096a)

    `http://localhost:3001/auth/login/callback?code=0dc61ca6-6ccd-4dae-8fac-70dd590fe8c6&type=logingov&state=c4addf6001661631d2524043ca31107e`
4. Copy the `code` URL parameter into your Postman SiS collection variables as the new `auth_code` and save the variables file. If you were using a newly generated `code_challenge` for the `/authorize` call you'll need to update the `code_verifier` variable as well.
5. You should now be able to use Postman to make a `/token` call, passing the `auth_code` and receiving a set of tokens that Postman will save to make further calls. Postman will also automatically update tokens for `/refresh` calls and wipe them for successful `/logout`, `/revoke`, and `/revoke_all` calls.

## Dev & Staging authentication

Interacting with dev & staging SiS through Postman is largely the same as the process on localhost; you will still need to authenticate through an `/authorize` request with a `code_challenge` that you have the corresponding `code_verifier` to, then copy the `code` passed to the frontend `/callback` route into Postman to receive your tokens. In addition, the following changes will need to be made to the preceding workflow:

1. The `vets_api_env` variable must be set to `https://{dev|staging}-api.va.gov` - note the necessary `https` scheme.
2. In order to prevent the vets-website frontend from calling the `/token` endpoint immediately and rendering the copied `code` useless you must prevent the request from sending in your browser's devtools: block `{dev|staging}-api.va.gov/v0/sign_in/token`

## Mocked Authentication

The Identity Postman collection can also interact with Sign in Service [mocked authentication](https://github.com/department-of-veterans-affairs/va.gov-team/tree/master/products/identity/Products/Mocked%20Authentication) service. The routes necessary for this are found under the `Sign In Service >> Mock Auth` directory. Unlike standard authentication which requires the web browser to perform a real login with the chosen credential service provider, mocked authentication can be performed entirely within Postman on localhost, development, and staging `vets-api` environments.

1. Call the `authorize state` route to generate the appropriate state. This call uses the `acr` and `csp_type` collection variables - set them for the CSP and ACR/LoA of the test user you wish to authenticate with. The returned state value is parsed from a 200 response and saved in the `mock_auth_state` collection variable.
2. Call the `credential_list` route with the same `csp_type` to receive a list of the mocked credentials currently available on the requested `vets-api` instance. After selecting a mock credential copy the `encoded_credential` value for that user and save it in the `mock_encoded_credential` collection parameter.
    * `encoded_credential` in the response
   ![encoded_credential](https://github.com/department-of-veterans-affairs/va.gov-team/assets/20125855/487cd01d-8dcb-481c-b628-7e38b7ecaf59)
    * saving the `mock_encoded_credential` collection variable
   ![encoded_credential_variable](https://github.com/department-of-veterans-affairs/va.gov-team/assets/20125855/9ff05dcd-42a3-41c0-88ab-f234f5821ee7)
3. Call the `mock authorize` endpoint with your updated `state` & `credential_info` values. If successful you will receive a similar response to the SiS `/callback` response with a `code` included. This `code` parameter will automatically be saved to the VA Identity `auth_code` collection variable.
4. You can now call the standard SiS PKCE Auth `/token` route, passing the saved `auth_code` collection variable. If successful you will receive a 200 response and have the returned tokens set to your VA Identity collection for use against authenticated routes.
