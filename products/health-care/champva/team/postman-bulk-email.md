# Sending Bulk Emails through VA Notify via Postman

## Executive Summary

This document provides a step by step process for sending a single email template
to multiple different email addresses via a single Postman batch run.

## Pre-requisites
- Postman installed
- A list of target email addresses, names, and relevant metadata compiled into a `.csv`.
  - The CSV header row should have one column for each expected email template value. Here is a sample CSV that works for the FMP1 confirmation email:
    ```csv
    email_address,first_name,date_submitted,lighthouse_updated_at
    john@email.gov,John,10/28/2024,10/28/2024
    ```
## Steps:
> [!NOTE]
> JWTs will be auto-generated by the script imported alongside the Postman collections and thus set in the environment when the request is run.
1. Read over the [README](https://github.com/department-of-veterans-affairs/notification-api/tree/main/documents/postman) in the VA Notifications API postman GitHub
2. Get the following Postman files from the notifications API [repo](https://github.com/department-of-veterans-affairs/notification-api/tree/main/documents/postman):
    - `notification-api-simplified.postman_collection`
    - `staging-simplified.postman_environment`
3. Open Postman and import the files retrieved from the notifications API repo
4. Set any necessary missing values in the staging-simplified environment. 
    - The IVC CHAMPVA VA Notify service API key is stored in an AWS param:
      `/dsva-vagov/vets-api/staging/env_vars/vanotify/services/ivc_champva/api_key`
    - The `template_id` environment variable should match the email you're trying to send. These IDs can be found in VA Notify or the IVC AWS param store.
    - Refer back to the notifications api [README](https://github.com/department-of-veterans-affairs/notification-api/tree/main/documents/postman) for other variables
5. Update the `send email` request to include the proper variable names (these will correspond to the variables the given VA Notify template expects AND the CSV headers in the CSV referenced in the pre-requisites section). Below is an example of the request configured for a bulk FMP1 confirmation email job:

    ![send_email_w_email](https://github.com/user-attachments/assets/26be2f84-b3be-4198-b6f9-5ad2745c9610)

6. Create a CSV with the information you need to perform bulk emails. The CSV should have a column for each variable needed by VA Notify to send the email (see FMP1 example in [pre-requisites](#pre-requisites) section above).
7. In the Postman sidebar, open the context menu for `send EMAIL` and, click `Run folder`

   ![context_menu](https://github.com/user-attachments/assets/6ef408db-b707-4e75-96c4-092dde5ab3f4 'Image of context menu')
   
8. On the new run screen
    - Ensure the staging-vanotify environment is selected in the upper right corner
    - Deselect all options except `POST send email with email_address`
    - Upload the CSV with rows of email addresses

    ![run_screen](https://github.com/user-attachments/assets/6fdda891-15bd-4dd2-9d6b-d9d51964136d 'Image of configured run screen')

9. Preview the CSV in Postman to make sure it is accurate, verifying that the number of records matches the expected amount.
  
    |Preview CSV button|CSV Preview|
    |-|-|
    |![preview](https://github.com/user-attachments/assets/827aab88-aabf-45d5-8904-2b1240ca6d65)|![csv_preview_open](https://github.com/user-attachments/assets/50c1ea03-578b-4fe5-b50f-11211c51f0f0)|
   
10. Click the orange `Run notification-api-simplified` button in the bottom right to trigger the emails.

    |Run button|Post-run screen|
    |-|-|
    |![run_screen_button](https://github.com/user-attachments/assets/a24b0657-8fd8-468a-bad0-ecfd35f976fd)|![ran](https://github.com/user-attachments/assets/52360a22-a441-465f-866e-2f03021ff8f7)|


11. Check your email to verify the notification came through as expected.

These steps should be the same for the production environment. To use, select the production environment from the dropdown in the upper right corner. You will also need to make sure any email template IDs are the production variants, as well as any AWS params (such as the api key)

Troubleshooting
- TODO
