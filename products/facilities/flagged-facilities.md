# Flagged Facilities
Last updated: 5/8/2024

The Facilities Team is responsible for ensuring that VA.gov presents the latest correct data available about a Facility. 
The Drupal CMS Helpdesk is responsible for communicating with Editors about changed Facilities, where relevant. 

The Facilities team and Drupal CMS Helpdesk work together to process information about changed Facilities, aka Flagged Facilities. The Lighthouse Facilities API is the source of truth for Facilities data. When the Facilities API reports certain kinds of data changes, Drupal CMS will add a Flag on that node, for followup. This document describes the process of handling / resolving those Flagged Facilities.

## High level process flow
* **Upstream databases:** Editors can make changes / change requests to update the status, naming, and other data about their facilities, in the relevant upstream database. That data is then pulled into the Lighthouse Facilities API.
  * VHA (VAMCs, Vet Centers) = facility data comes from VAST
  * VBA = facility data comes from Sandy's Database
* **Drupal** migrates upstream data into the CMS every night via the Lighthouse Facilities API. 
  * On migration, Flags will be added to Facilities that are removed from source, added, or changed. 
  * Those flagged facilities will appear here for moderation: https://prod.cms.va.gov/admin/content/facilities/flagged.
  * The [Flagged Content view](https://prod.cms.va.gov/admin/content/facilities/flagged) should be maintained with an "inbox zero" goal. 
* **Helpdesk**: needs to review that queue and create Github tickets using the appropriate [Runbook](https://github.com/department-of-veterans-affairs/va.gov-team/blob/master/products/facilities/flagged-facilities.md#runbooks) below, based on the type of facility, and type of flag.  
  * If Helpdesk does not have bandwidth, alert Facilities team and ask for help creating Github tickets.
  * https://github.com/department-of-veterans-affairs/va.gov-cms/issues/13624 will eventually create a Flag to track which Flagged facilities don't have Github tickets. Until then: Helpdesk can keep track of the process for creating Github tickets however they like, using "Stefanie's spreadsheet" or otherwise.
* Then: **Helpdesk and Facilities** all follow the Github runbook tickets. 
  * Within each runbook ticket, the steps required by Helpdesk (specifically), Drupal engineering, or "Drupal Admin" (which could be either engineers or Helpdesk) are articulated, in order. 
  * Each new sprint, tickets related to flagged facilities will be prioritized, at the discretion of the Facilities PO, relative to other sprint priorities.
  * Each type of facility/flag has different steps, necessarily, so read the ticket for steps, and @ mention each other (Facilities engineers and Helpdesk) in the comments when the ticket is ready for next steps by the other party. 


## Flagging logic - engineering
Flags are determined via Drupal CMS config files, e.g.
* [New facility flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.new.yml)
* [Changed name flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.changed_name.yml)
* [Removed from source (removed_from_source) flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.removed_from_source.yml)
* These flags should only be removed from a facility with all work has been completed and the only step remaining in communication with stakeholders that the work has been completed.

## Flags that are applied manually
The "⏳ Awaiting ..." flags are applied while working the Flagged Facilities in the [Flagged Content view](https://prod.cms.va.gov/admin/content/facilities/flagged). They are secondary and should never be the only flags on a facility.
* "⏳ Awaiting Editor" should be applied by Help Desk while awaiting approval, confirmation that a new homepage draft is ready for review, or holding off until a specific date when the facility's status can be changed.
* "⏳ Awaiting Redirect" should be applied by a CMS Engineer, as a step in the URL Redirect workflow in the [URL Change runbook](runbook-facility-url-change.md).
* "⏳ Awaiting CSV" should be applied by a CMS Engineer, as a step in the Canonical URL change workflow in the [URL Change runbook](runbook-facility-url-change.md).

## Runbooks 
When a Facility is flagged, the facility type and the nature of the flag will determine the runbook that should be used to mitigate the flag. 

**Updated 6/30/23**
| | | Flags | | |                                                                                                                                                                                                                                                                                                                                                        
| --- |--- |--- |--- |--- |
| ADMINISTRATION | Facility type | New facility | Changed name | Removed from source |
| VHA | VAMC System   | Systems are not present in VAST, and do not get flagged.<br>([flag new config](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.new.yml)). No associated runbook. (Runbook creation ticketed: [#15264](https://github.com/department-of-veterans-affairs/va.gov-cms/issues/15264). Some notes in [#3754](https://github.com/department-of-veterans-affairs/va.gov-cms/issues/3754) may be useful to create a runbook if needed.)| [runbook-vamc-system-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-system-name-change.md)<br>System name change does not automatically receive a flag. If we learn of a System name change, we must manually identify to run this runbook. | Systems are not present in VAST, and do not get flagged.<br>([flag removed_from_source config](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.removed_from_source.yml#L9)). No associated runbook. |
| VHA | VAMC Facility                                                                                                                                                                                                                                                                                                                                                                                         | [runbook-vamc-facility-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-new.md)<br><br>[runbook-vamc-facility-duplicate-or-section-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-duplicate-or-section-change.md)<br>Comes in as a New facility that we then have to manually ID as a dupe. Can happen if a Facility is moved between Systems and receives a new Facility ID (via accident or VAST mystery).                                                                                                                                                                                                | [runbook-vamc-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-name-change.md) |[runbook-vamc-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-closed.md) |
| VHA | Vet Center | [runbook-vet-center-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-new.md) |[runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md) |
| VHA | Vet Center - Outstation | [runbook-vet-center-cap-to-outstation.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-cap-to-outstation.md)<br>Vet Center CAP becoming an outstation may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook. | [runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md)  Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.| [runbook-vet-center-outstation-to-vet-center.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-outstation-to-vet-center.md)<br>Vet Center Outstation becoming an outstation may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook.|
| VHA | Vet Center - Mobile Vet Center | [runbook-vet-center-new.md<br>](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-new.md)Mobile Vet Centers can be sold between Vet Centers, and may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook to verify the parent Vet Center. | [runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md) Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.|
| VBA| VBA Facility | [runbook-vba-facility-new.md<br>](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-new.md)Runbook = prompt editors to add an operating status. | [runbook-vba-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-name-change.md)<br>Runbook = update Section term to new name. Could be automated / runbook retired until production workflow launches. | [runbook-vba-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-closed.md)<br>Runbook = delete Section term. Could be automated / runbook retired until production workflow launches. |
| NCA| NCA Facility | [runbook-nca-facility-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-new.md)<br>Runbook = notify an editor to set an operating status so that it gets pushed to the Facility API.                                                                                                 | [runbook-nca-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-name-change.md)<br>Runbook = update alias to match new facility name. Could be automated / runbook retired until production workflow launches. | [runbook-nca-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-closed.md)<br>Runbook = move node status to Archived. Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.  When the product launches, we will need to revisit the autoarchive and the closed runbook. |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              The [runbook-facility-url-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-facility-url-change.md) is also referenced by many of these runbacks.

Some NCA & VBA flags could theoretically be removed / stop flagging. However: data changes are happening now on draft nodes that will require action before publishing, e.g. data for alias / operating status / Section terms / archive status. This partially because some data changes for NCA/VBA are not yet automated.  
