# Flagged Facilities
The Lighthouse Facilities API is the source of truth for Facilities data. When the Facilities API reports certain kinds of data changes, Drupal CMS will add a Flag on that node, for followup. 

Flagged items then appear in Drupal's [Flagged Content view](https://prod.cms.va.gov/admin/content/facilities/flagged) for moderation. 

## Managing Flagged Facilities
The [Flagged Content view](https://prod.cms.va.gov/admin/content/facilities/flagged) should be maintained with an "inbox zero" goal. 
* In preparation for every new sprint, tickets are created for any new flags that have appeared since last sprint planning cycle.
* Each new sprint, tickets related to flagged facilities will be prioritized, at the discretion of the Facilities PO, relative to other sprint priorities.

## Flagging logic - engineering
Flags are determined via Drupal CMS config files, e.g.
* [New facility flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.new.yml)
* [Changed name flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.changed_name.yml)
* [Removed from source (removed_from_source) flag](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.removed_from_source.yml)
* These flags should only be removed from a facility with all work has been completed and the only step remaining in communication with stakeholders that the work has been completed.

## Flags that are applied manually
The "⏳ Awaiting ..." flags are applied while working the Flagged Facilities in the [Flagged Content view](https://prod.cms.va.gov/admin/content/facilities/flagged). They are secondary and should never be the only flags on a facility.
* "⏳ Awaiting Editor" should be applied by Help Desk while awaiting approval, confirmation that a new homepage draft is ready for review, or holding off until a specific date when the facility's status can be changed.
* "⏳ Awaiting Redirect" should be applied by a CMS Engineer, as a step in the URL Redirect workflow in the [URL Change runbook](runbook-facility-url-change.md).
* "⏳ Awaiting CSV" should be applied by a CMS Engineer, as a step in the Canonical URL change workflow in the [URL Change runbook](runbook-facility-url-change.md).

## Runbooks 
When a Facility is flagged, the facility type and the nature of the flag will determine the runbook that should be used to mitigate the flag. 

**Updated 6/30/23**
| | | Flags | | |                                                                                                                                                                                                                                                                                                                                                        
| --- |--- |--- |--- |--- |
| ADMINISTRATION | Facility type | New facility | Changed name | Removed from source |
| VHA | VAMC System   | Systems are not present in VAST, and do not get flagged.<br>([flag new config](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.new.yml)). No associated runbook. (Some notes in [#3754](https://github.com/department-of-veterans-affairs/va.gov-cms/issues/3754) may be useful to create a runbook if needed.)| [runbook-vamc-system-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-system-name-change.md)<br>System name change does not automatically receive a flag. If we learn of a System name change, we must manually identify to run this runbook. | Systems are not present in VAST, and do not get flagged.<br>([flag removed_from_source config](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/config/sync/flag.flag.removed_from_source.yml#L9)). No associated runbook. |
| VHA | VAMC Facility                                                                                                                                                                                                                                                                                                                                                                                         | [runbook-vamc-facility-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-new.md)<br><br>[runbook-vamc-facility-duplicate-or-section-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-duplicate-or-section-change.md)<br>Comes in as a New facility that we then have to manually ID as a dupe. Can happen if a Facility is moved between Systems and receives a new Facility ID (via accident or VAST mystery).                                                                                                                                                                                                | [runbook-vamc-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-name-change.md) |[runbook-vamc-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vamc-facility-closed.md) |
| VHA | Vet Center | [runbook-vet-center-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-new.md) |[runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md) |
| VHA | Vet Center - Outstation | [runbook-vet-center-cap-to-outstation.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-cap-to-outstation.md)<br>Vet Center CAP becoming an outstation may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook. | [runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md)  Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.| [runbook-vet-center-outstation-to-vet-center.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-outstation-to-vet-center.md)<br>Vet Center Outstation becoming an outstation may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook.|
| VHA | Vet Center - Mobile Vet Center | [runbook-vet-center-new.md<br>](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-new.md)Mobile Vet Centers can be sold between Vet Centers, and may appear as a New facility flag, with a new Facility API ID. We must manually identify to run this runbook to verify the parent Vet Center. | [runbook-vet-center-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-name-change.md) | [runbook-vet-center-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vet-center-closed.md) Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.|
| VBA| VBA Facility | [runbook-vba-facility-new.md<br>](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-new.md)Runbook = prompt editors to add an operating status. | [runbook-vba-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-name-change.md)<br>Runbook = update Section term to new name. Could be automated / runbook retired until production workflow launches. | [runbook-vba-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-vba-facility-closed.md)<br>Runbook = delete Section term. Could be automated / runbook retired until production workflow launches. |
| NCA| NCA Facility | [runbook-nca-facility-new.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-new.md)<br>Runbook = notify an editor to set an operating status so that it gets pushed to the Facility API.                                                                                                 | [runbook-nca-facility-name-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-name-change.md)<br>Runbook = update alias to match new facility name. Could be automated / runbook retired until production workflow launches. | [runbook-nca-facility-closed.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-nca-facility-closed.md)<br>Runbook = move node status to Archived. Since these have no FE page of their own, they autoarchive when they are removed from the Facility API.  When the product launches, we will need to revisit the autoarchive and the closed runbook. |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              The [runbook-facility-url-change.md](https://github.com/department-of-veterans-affairs/va.gov-cms/blob/main/.github/ISSUE_TEMPLATE/runbook-facility-url-change.md) is also referenced by many of these runbacks.

Some NCA & VBA flags could theoretically be removed / stop flagging. However: data changes are happening now on draft nodes that will require action before publishing, e.g. data for alias / operating status / Section terms / archive status. This partially because some data changes for NCA/VBA are not yet automated.  
