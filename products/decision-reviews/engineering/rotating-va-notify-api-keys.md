# Rotating VA Notify API Keys

## Overview

VA Notify API keys must be rotated every **180 days** for security compliance. This document outlines the process for rotating the Benefits Decision Review API keys.

## Key Information

### API Key Format

The VA Notify API key is constructed from three values:
```
#{key-name}-#{service-id}-#{secret}
```

### Rotation Schedule

- **Frequency**: Every 180 days
- **Key Delivery**: New keys are generated and sent via encrypted email to the designated group
- **Activation**: New keys are active immediately upon generation
- **Validity**: Each key is valid for 180 days from generation

## Rotation Process

### Step 1: Receive New API Key

New keys will be generated by the VA Notify team and sent via encrypted email to the designated group.

### Step 2: Update AWS Parameter Store

Update the following parameters in AWS Parameter Store with the new API key:

> ⚠️ **Important:** Do not update the production parameter until staging has been fully tested and verified (see Step 6 below).

**Staging Environment:**
```
/dsva-vagov/vets-api/staging/env_vars/vanotify/services/benefits_decision_review/api_key
```

**Production Environment:**
```
/dsva-vagov/vets-api/prod/env_vars/vanotify/services/benefits_decision_review/api_key
```


**Instructions:**
1. Navigate to AWS Systems Manager → Parameter Store
2. Locate each parameter path above
3. Update the "value" text field with the API Key
4. Save changes

### Step 3: Wait for Deployment and Verify Settings

After updating the AWS Parameter Store, you must wait for vets-api to deploy before testing. This typically occurs the following day.

**Verify the API Key in Rails Console:**

1. Access the Rails console via [Argo Staging](https://argocd.vfs.va.gov/applications/vets-api-staging) in the CAG environment
2. Run the following command to verify the API key has been updated:

```ruby
Settings.vanotify.services.benefits_decision_review.api_key
```

3. Confirm that the output matches the new API key you updated in AWS Parameter Store

> **Important:** Do not proceed to testing until this value reflects the changes made in AWS Parameter Store.

### Step 4: Test in Staging

After verifying the settings have been updated, test the new key using test data.

**Create Test Data:**

To test the email delivery, create an AppealSubmission in staging with your own email address. This will allow you to verify that emails are sent successfully to your inbox.

**Test Data (Example):**

`AppealSubmissionUpload id: 260 lighthouse_upload_id: "1c542c2d-c0f6-4852-ba33-bdd962cd599e"`

AppealSubmissionUpload example:
- ID: `260`
- Lighthouse Upload ID: `1c542c2d-c0f6-4852-ba33-bdd962cd599e`

**Run the test command:**

> **Note:** Execute this command using the Rails console in the CAG environment via [Argo Staging](https://argocd.vfs.va.gov/applications/vets-api-staging).

Test with your newly created submission (replace with your AppealSubmission ID):
```bash
UPLOAD_TO_S3=false DRY_RUN=false APPEAL_SUBMISSION_IDS='<your-submission-id>' bundle exec rake decision_reviews:remediation:send_form_recovery_emails
```

**Verify Email Delivery:**

After running the command, check your email inbox to confirm you received the notification. This verifies that the new API key is working correctly.

### Step 5: Verify Delivery in Datadog

Check Datadog monitors to confirm emails were delivered successfully:

- [**Evidence recovery emails monitor**](https://vagov.ddog-gov.com/logs?query=env%3Aeks-staging%20%40payload.callback_metadata.email_type%3Aevidence_recovery&agg_m=count&agg_m_source=base&agg_t=count&clustering_pattern_field_path=message&cols=host%2Cservice&fromUser=true&messageDisplay=inline&refresh_mode=sliding&storage=flex_tier&stream_sort=desc&viz=stream&from_ts=1763753509926&to_ts=1764012709926&live=true)
- [**Form recovery emails monitor**](https://vagov.ddog-gov.com/logs?query=env%3Aeks-staging%20%40payload.callback_metadata.email_type%3Aform_recovery&agg_m=count&agg_m_source=base&agg_t=count&clustering_pattern_field_path=message&cols=host%2Cservice&fromUser=true&messageDisplay=inline&refresh_mode=sliding&storage=flex_tier&stream_sort=desc&viz=stream&from_ts=1763915240805&to_ts=1764088040805&live=true)


### Step 6: Update Production

Once staging is verified:
1. Update the production parameter in AWS Parameter Store
2. Monitor production Datadog dashboards for any issues

## Future Improvements

The VA Notify team is working on a UI feature that will enable developers to self-service API key generation. This feature will be available in the same interface where email templates are currently managed.

Until the self-service feature is available, key rotation will continue to be handled manually as described above.

## Responsibilities

- **Team Responsibility**: It is the Decision Reviews team's responsibility to manage key rotation
- **Action Item**: Update keys in AWS Parameter Store upon receipt from VA Notify
- **Documentation**: Keep this document updated with any process changes

## Contact

For issues with key rotation or VA Notify integration, contact:
- **VA Notify Team**: #va-notify-public (Slack)
- **Platform Support**: #vfs-platform-support (Slack)

## Last Updated

Document created: December 22, 2025
