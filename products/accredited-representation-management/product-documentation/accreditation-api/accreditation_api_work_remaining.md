# Accreditation API remaining work before and after intergration
## Before Integration

1. **Fix the Address Validation Issues**: There are currently two issues that need to be addressed regarding address validation:
  - Right now the daily API processing job is setting the raw address field and any other available address fields for `AccreditedIndividual` records.  This is a bug that could lead to address fields correctly set by the Address Validator being overwritten with unvalidated user submitted data served up by the Accreditation API. This needs to be modified so that address fields are not set during API processing and are only set when the address is validated through the address validation service.  This is ticketed at: https://github.com/department-of-veterans-affairs/va.gov-team/issues/116119.
  - The `AccreditedIndividual` records with an `individual_type` of `representative` are not having their addresses validated. This needs to be fixed so that representatives' addresses are also validated.  For other individual types, a similar problem was investigated by gathering some sample responses in the console, and redefining the API processing job (`RepresentationManagement::AccreditedEntitiesQueueUpdates`) to prepare the json data for the address validation job (`RepresentationManagement::AccreditedIndividualsUpdate`) and redefining the address validation job to operate on that prepared data and examine the results.
1. **Test in Staging**: Once the address validation issues are fixed, test the Accredited Entity endpoints in the staging environment.  This includes:
  - Testing the Find a Rep and Appoint applications to ensure that they display reps when they should and that the way the display their information is correct.
1. **Investigate inconsistencies and fix if necessary**: During staging testing some claims agents would appear in Appoint but not in Find a Rep.  Any `AccreditedIndividual` records that appear in Find should be in Appoint, and vice versa. If there are inconsistencies, investigate the cause and fix it. Start with the queries in the Find and Appoint endpoints.  Impacted claims agents are Emma Lund and Rick Little.
1. **Use the feature flag in vets-website to conditionally use the Accredited Entity endpoints**: `find_a_representative_use_accredited_models` is already set up in `vets-api`.  Right now `vets-website` is using the Accredited Entity endpoints in the local and staging environments but this is accomplished with an environment check.  A feature flag would allow us to test in staging and prod with specific users.
1. **When testing is complete enable in Production**: Whether through a feature flag or by hardcoding the Accredited Entity endpoints, enable the Accredited Entity endpoints in production.

## After Integration      
1. **Misc updates to Accreditation code**:
  - Reduce the Address Validation logging in the notifications channel.  We will lean on the new daily report to get a handle on the magnitude of address validation issues.
  - Copyedit the daily report to make any mention of "representatives" clear that it means "VSO representatives".
  - Generate fresh swagger docs for the `RepresentationManagement` module.  There are some swagger specs that are in place but they have never been generated into docs.
  - All this work is ticketed at: https://github.com/department-of-veterans-affairs/va.gov-team/issues/114730.
1. **Update the Rep Status to use the Accredited Entity data**: Right now this uses the legacy data souce.  Move it to use the Accredited Entity records.  This is ticketed at: https://github.com/department-of-veterans-affairs/va.gov-team/issues/114589.
1. **Set `registration_number` on `representative` records**: Right now the `registration_number` field is not set on `AccreditedIndividual` records with an `individual_type` of `representative`.  This is because the `registration_number` is not available in the GCLAWS API.  We have asked them to add it and they confirmed that they would.  This request can be tracked in Teams.  Claims agents and attorneys both have a `number` field in their API responses that we persist in the `registration_number` field.  Representatives do not have this field in their API responses, so we need to wait for the GCLAWS API to add it before we can set it.

## Possible Future Enhancements
1. **Refactor the Address Validation process**: Right now the Address Validation process depends on json prepared by the API processing job.  We persist everything to the database that we need to submit to the Address Validation API.  Simplifying the code so that we could call `#validate_address` on the `AccreditedIndividual` model directly would be a nice enhancement.  This would allow us to make the `RepresentationManagement::AccreditedIndividualsUpdate` job much simpler and would allow us to more easily investigate address validation issues by calling `#validate_address` in the console and examining the results.
1. **Automatically tie legacy data to the Accredited Entity data**: Once we are setting `registration_number` on `AccreditedIndividual` records with an `individual_type` of `representative`, we can automatically tie legacy data to the Accredited Entity data.  This would allow us to compare the address validation status of legacy data to the Accredited Entity data to help us understand any differences between the two.
1. **Disable stale data deletion if any errors are thrown**: There has been at least one instance of the `RepresentationManagement::AccreditedEntitiesQueueUpdates` job throwing an error when its connection to the GCLAWS API is lost.  This caused a smaller number of Attorney records to be processed, and that led to many Attorney records being deleted that should not have been.  We should disable the stale data deletion if any errors are thrown in the `RepresentationManagement::AccreditedEntitiesQueueUpdates` job.  This would allow us to investigate the error and fix it before any data is deleted.
