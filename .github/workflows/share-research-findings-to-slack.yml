name: Share Research Findings to Slack

on:
  push:
    paths:
      - 'products/**/[Ff]indings.md'
      - 'products/**/[Rr]eport.md'
      - 'products/**/[Ii]nsights.md'
      - 'products/**/[Rr]esearch-[Ff]indings.md'
      - 'products/**/[Rr]esearch-[Rr]eport.md'
      - 'products/**/[Rr]esearch-[Ii]nsights.md'
      - 'products/**/[Uu]ser-[Rr]esearch-[Ff]indings.md'
      - 'products/**/[Uu]ser-[Rr]esearch-[Rr]eport.md'
      - 'products/**/[Ss]tudy-[Ff]indings.md'
      - 'products/**/[Ss]tudy-[Rr]eport.md'
      - 'teams/**/[Ff]indings.md'
      - 'teams/**/[Rr]eport.md'
      - 'teams/**/[Ii]nsights.md'
      - 'teams/**/[Rr]esearch-[Ff]indings.md'
      - 'teams/**/[Rr]esearch-[Rr]eport.md'
      - 'teams/**/[Rr]esearch-[Ii]nsights.md'
      - 'teams/**/[Uu]ser-[Rr]esearch-[Ff]indings.md'
      - 'teams/**/[Uu]ser-[Rr]esearch-[Rr]eport.md'
      - 'teams/**/[Ss]tudy-[Ff]indings.md'
      - 'teams/**/[Ss]tudy-[Rr]eport.md'
    branches:
      - master
      - main
  schedule:
    # Run daily to check for reports that are ready to share
    - cron: '0 14 * * *'  # 2 PM UTC = 10 AM ET / 7 AM PT
  workflow_dispatch:
    inputs:
      research_file_path:
        description: 'Path to specific research file (optional - leave blank to process all eligible files)'
        required: false
        type: string
      ignore_time_delay:
        description: 'Ignore 3-day waiting period (for testing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: write

jobs:
  share-research-findings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Optimized checkout for large repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Use shallow clone for better performance
          sparse-checkout: |
            .github/workflows/
            scripts/github-actions/
            products/
          sparse-checkout-cone-mode: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Find eligible research files
        id: find-files
        run: |
          python scripts/github-actions/share-research-findings-to-slack/research_finder.py \
            "${{ github.event_name }}" \
            "${{ github.event.inputs.research_file_path }}" \
            "${{ github.event.inputs.ignore_time_delay }}"

      - name: Process and extract research content
        if: steps.find-files.outputs.skip != 'true'
        run: |
          python scripts/github-actions/share-research-findings-to-slack/research_processor.py \
            "${{ steps.find-files.outputs.eligible_files }}"

      - name: Build Slack payload
        if: steps.find-files.outputs.skip != 'true' && env.RESEARCH_FILE
        id: build-payload
        run: |
          # Escape JSON special characters in environment variables
          RESEARCH_TITLE_ESCAPED=$(echo "${RESEARCH_TITLE}" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          PRODUCT_PATH_ESCAPED=$(echo "${PRODUCT_PATH}" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          STUDY_DATE_ESCAPED=$(echo "${STUDY_DATE}" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          KEY_FINDINGS_ESCAPED=$(echo "${KEY_FINDINGS}" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          RESEARCH_FILE_ESCAPED=$(echo "${RESEARCH_FILE}" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          
          # Determine context message
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CONTEXT_MESSAGE="ðŸ§ª _Test notification - not tracked as shared_"
          else
            CONTEXT_MESSAGE="âœ¨ _Shared after 3-day revision period_"
          fi
          
          # Build the JSON payload without channel (will be specified separately)
          cat > slack_payload.json << EOF
          {
            "text": "ðŸ“Š New Research Findings Available: ${RESEARCH_TITLE_ESCAPED}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸ“Š New Research Findings Available",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Study:*\\n${RESEARCH_TITLE_ESCAPED}"
                  },
                  {
                    "type": "mrkdwn", 
                    "text": "*Product Area:*\\n${PRODUCT_PATH_ESCAPED}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Date:*\\n${STUDY_DATE_ESCAPED}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Key Findings:*\\n${KEY_FINDINGS_ESCAPED}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ðŸ“– Read Full Report",
                      "emoji": true
                    },
                    "url": "https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${RESEARCH_FILE_ESCAPED}",
                    "style": "primary"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "${CONTEXT_MESSAGE}"
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "Slack payload built successfully"

      - name: Send Slack notification - Success
        if: steps.find-files.outputs.skip != 'true' && env.RESEARCH_FILE
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
          payload-file-path: slack_payload.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_ACCESS_TOKEN_RSRCH_OPS }}

      - name: Send Slack notification - Error
        if: steps.find-files.outputs.skip == 'true' && steps.find-files.outputs.error_message && github.event_name == 'workflow_dispatch'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
          payload: |
            {
              "text": "âŒ Research File Not Found",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Could not find the specified research file*\\n\\n`${{ steps.find-files.outputs.error_message }}`\\n\\nPlease check the file path and try again."
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_ACCESS_TOKEN_RSRCH_OPS }}

      - name: Update tracking file
        if: steps.find-files.outputs.skip != 'true' && github.event_name != 'workflow_dispatch' && env.RESEARCH_FILE
        run: |
          echo "${{ env.RESEARCH_FILE }}" >> .github/workflows/shared-research-files.log

      - name: Commit tracking file
        if: steps.find-files.outputs.skip != 'true' && github.event_name != 'workflow_dispatch' && env.RESEARCH_FILE
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Track shared research file: ${{ env.RESEARCH_FILE }}"
          file_pattern: .github/workflows/shared-research-files.log
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
