name: Share Research Findings to Slack

on:
  push:
    paths:
      - 'products/**/[Ff]indings.md'
      - 'products/**/[Rr]eport.md'
      - 'products/**/[Ii]nsights.md'
      - 'products/**/[Rr]esearch-[Ff]indings.md'
      - 'products/**/[Rr]esearch-[Rr]eport.md'
      - 'products/**/[Rr]esearch-[Ii]nsights.md'
      - 'products/**/[Uu]ser-[Rr]esearch-[Ff]indings.md'
      - 'products/**/[Uu]ser-[Rr]esearch-[Rr]eport.md'
      - 'products/**/[Ss]tudy-[Ff]indings.md'
      - 'products/**/[Ss]tudy-[Rr]eport.md'
    branches:
      - master
      - main
  schedule:
    - cron: '0 14 * * *'
  workflow_dispatch:
    inputs:
      research_file_path:
        description: 'Path to specific research file (optional - leave blank to process all eligible files)'
        required: false
        type: string
      ignore_time_delay:
        description: 'Ignore 3-day waiting period (for testing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: write

jobs:
  share-research-findings:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/workflows/
            products/
            scripts/
            platform/
            docs/
            templates/
            assets/
          sparse-checkout-cone-mode: false
          filter: blob:none

      - name: Configure Git LFS (if needed)
        run: |
          git lfs install
          echo "Git LFS installed (only pulls if LFS pointers in sparse set)"

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found; installing..."
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Make scripts executable
        run: |
          chmod +x scripts/github-actions/share_to_slack/*.sh || true
          chmod +x scripts/github-actions/share_to_slack/*.py || true

      - name: Find eligible research files (script)
        id: find-files
        env:
          RESEARCH_FILE_PATH: ${{ github.event.inputs.research_file_path }}
          IGNORE_TIME_DELAY: ${{ github.event.inputs.ignore_time_delay }}
          WAIT_DAYS: 3
          SHARED_FILES_LOG: .github/workflows/shared-research-files.log
        run: |
          set -euo pipefail
          ./scripts/github-actions/share_to_slack/find_eligible_research_file.sh
          echo "Raw step output file contents:"; cat "$GITHUB_OUTPUT" || true

      - name: Process and share research findings (python)
        if: steps.find-files.outputs.skip != 'true'
        id: process
        run: |
          set -euo pipefail
          FILE="${{ steps.find-files.outputs.eligible_file }}"
          if [ -z "$FILE" ]; then
            echo "No file provided from previous step"; exit 0; fi
          python3 --version
          python3 scripts/github-actions/share_to_slack/process_research_file.py "$FILE"

      - name: Build Slack payload (success) (script)
        if: steps.find-files.outputs.skip != 'true' && steps.process.outputs.RESEARCH_FILE
        id: build-slack-success
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
          EVENT_NAME: ${{ github.event_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${SLACK_CHANNEL_ID}" ]; then echo "Missing SLACK_RSRCH_FINDINGS_CHANNEL_ID" >&2; exit 1; fi
          ./scripts/github-actions/share_to_slack/build_slack_payload_success.sh

      - name: Send Slack notification - Success
        if: steps.find-files.outputs.skip != 'true' && steps.process.outputs.RESEARCH_FILE
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
          payload: ${{ steps.build-slack-success.outputs.payload }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_ACCESS_TOKEN_RSRCH_OPS }}

      - name: Build Slack payload (error) (script)
        if: steps.find-files.outputs.skip == 'true' && steps.find-files.outputs.error_message && github.event_name == 'workflow_dispatch'
        id: build-slack-error
        env:
            SLACK_CHANNEL_ID: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
            ERROR_MESSAGE: ${{ steps.find-files.outputs.error_message }}
        run: |
          set -euo pipefail
          if [ -z "${SLACK_CHANNEL_ID}" ]; then echo "Missing SLACK_RSRCH_FINDINGS_CHANNEL_ID" >&2; exit 1; fi
          ./scripts/github-actions/share_to_slack/build_slack_payload_error.sh

      - name: Send Slack notification - Error
        if: steps.find-files.outputs.skip == 'true' && steps.find-files.outputs.error_message && github.event_name == 'workflow_dispatch'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_RSRCH_FINDINGS_CHANNEL_ID }}
          payload: ${{ steps.build-slack-error.outputs.payload }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_ACCESS_TOKEN_RSRCH_OPS }}

      - name: Append tracking log
        if: steps.find-files.outputs.skip != 'true' && github.event_name != 'workflow_dispatch' && steps.process.outputs.RESEARCH_FILE
        run: |
          echo "${{ steps.process.outputs.RESEARCH_FILE }}" >> .github/workflows/shared-research-files.log

      - name: Commit tracking file
        if: steps.find-files.outputs.skip != 'true' && github.event_name != 'workflow_dispatch' && steps.process.outputs.RESEARCH_FILE
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Track shared research file: ${{ steps.process.outputs.RESEARCH_FILE }}"
          file_pattern: .github/workflows/shared-research-files.log
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
