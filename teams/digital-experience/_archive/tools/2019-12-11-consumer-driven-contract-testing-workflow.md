# Consumer-driven Contract Testing Workflow

This is an initial draft of the proposed workflow for integration testing using Pact and the Pact Broker, following up from the discovery summarized in [Consumer-driven Contract Testing with Pact](https://github.com/department-of-veterans-affairs/va.gov-team/blob/4e01454bec0c8c0138ffd7d1e25d056275b5cab6/teams/vsp/teams/tools/2019-11-13-consumer-driven-contract-testing-with-pact.md). Any commands listed in this document assume a similar setup to that described in the previous document. The example from that previous document does not fully represent the finalized process, and next steps to achieve the desired process are proposed [below](#todo).



## General Rules

For the consumers (VFS apps):

- Every consumer build (whether `main` or feature branch) generates a pact.
- The consumer publishes a pact to the broker with a tag that includes the branch name.
- When working on feature branches, developers should check `can-i-deploy` before merging and after any necessary provider changes are pushed to `main`.

For the provider (VA.gov API):

- Every provider build (whether `main` or feature branch) verifies against the latest pact generated by the consumer that's tagged as `main`.
- The provider publishes the results of the verification task. Failing verification should fail the build.
- When working with a consumer on a new feature, verify the pact generated from the consumer's feature branch. Then any changes on the provider side should be merged first and pass verification against the consumer's stable branch in CI.



## Workflows

### Adding a new interaction or changing an existing interaction in a VFS app

1. Create a feature branch for the consuming app with corresponding contract tests for the new or modified interaction.
2. Run the contract tests locally. The tests should fail unless the interaction has been implemented in the app.

    ```
    BUILDTYPE=localhost yarn test:unit src/applications/hca/tests/hca.contract.spec.js --timeout 10000
    ```

3. When the contract tests pass and generate a new pact, commit the newly generated pact and push the changes.
4. When the changes are pushed to GitHub, and the tests pass, the build should publish any new pacts.

    ```
    # This command would presumably run at the end of the CI build.
    yarn pact:publish
    ```

5. The provider should create a corresponding feature branch and tag for verifying the pact generated by the consumer.
6. The provider makes any necessary changes, and pushes to `main`.
7. The consumer should be able to merge the feature branch into `main`.

### Adding or changing an existing endpoint in the API

1. Create a feature branch in the provider with any intended changes.
2. During CI builds, the provider will verify that the changes don't break any interactions described by the latest `main` pacts generated by consumers.

    ```
    rake pact:verify
    ```

3. As long as the changes don't fail verification, the build should pass, and the changes should be good to merge.
4. If the build fails due to verification, discuss with consumers about any necessary changes to the interaction, and follow the steps for the scenario of adding or changing interactions in a VFS app.



## TODO

- Improve on the solution for mocking external services when verifying the pacts in the API (potentially referencing VCR cassettes)
- Determine what mechanism to use to facilitate exchange of contracts (Pact Broker? PactFlow? Common repository or location?)
- Set up Pact Broker as an internal tool if it was chosen as the mechanism of exchanging contracts
- Automate the publication and verification flow in CI
    - Automatically tag published pacts and verification results with the names of the corresponding feature branches, matching the branch names between consumer and provider to ensure proper communication
    - Figure out how to leverage webhooks to report results in GitHub for feature branch PRs


### Resources

- [Automate the contract and verification results exchange](https://docs.pact.io/best_practices/pact_nirvana#4-automate-the-contract-and-verification-results-exchange)
- [How would I use the Pact Broker?](https://github.com/pact-foundation/pact_broker#how-would-i-use-the-pact-broker)
- [Using tags](https://github.com/pact-foundation/pact_broker/wiki/Using-tags)
    - [pact-node publishing options](https://github.com/pact-foundation/pact-node#pact-broker-publishing)
    - [pact-ruby verification with specific tags](https://github.com/pact-foundation/pact-ruby/wiki/Verifying-pacts#fetching-pacts-from-a-pact-broker)
